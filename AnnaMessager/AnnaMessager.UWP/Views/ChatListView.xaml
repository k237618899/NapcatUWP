<views:MvxWindowsPage
    x:Class="AnnaMessager.UWP.Views.ChatListView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:views="using:MvvmCross.Uwp.Views"
    xmlns:converters="using:AnnaMessager.UWP.Converters"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <views:MvxWindowsPage.Resources>
        <x:Double x:Key="StandardContentWidth">520</x:Double>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:EmptyListToVisibilityConverter x:Key="EmptyListToVisibilityConverter" />
        <converters:PinnedBackgroundConverter x:Key="PinnedBgConverter" />

        <DataTemplate x:Key="ChatItemTemplate">
            <Grid Height="68" Padding="0" Background="Transparent">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="72"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="82"/>
                </Grid.ColumnDefinitions>
                <Rectangle Fill="{ThemeResource SystemControlForegroundBaseLowBrush}" Height="1" VerticalAlignment="Top" Opacity="0.15" Grid.ColumnSpan="3"/>
                <Grid x:Name="HoverHost" Background="Transparent" Grid.ColumnSpan="3">
                    <VisualStateManager.VisualStateGroups>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal" />
                            <VisualState x:Name="PointerOver">
                                <VisualState.Setters>
                                    <Setter Target="HoverHost.Background" Value="#11007ACC" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateManager.VisualStateGroups>
                </Grid>
                <Ellipse Width="48" Height="48" Grid.Column="0" VerticalAlignment="Center" Margin="16,0,8,0">
                    <Ellipse.Fill>
                        <ImageBrush ImageSource="{Binding AvatarUrl}" Stretch="UniformToFill" />
                    </Ellipse.Fill>
                </Ellipse>
                <StackPanel Grid.Column="1" Margin="0,0,8,0" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding Name}" FontSize="16" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" />
                        <FontIcon Glyph="&#xE141;" Margin="4,0,0,0" Foreground="{ThemeResource SystemControlForegroundBaseMediumHighBrush}" FontSize="14" Visibility="{Binding IsPinned, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <FontIcon Glyph="&#xE15D;" Margin="4,0,0,0" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" FontSize="14" Visibility="{Binding IsMuted, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </StackPanel>
                    <TextBlock Text="{Binding LastMessage}" FontSize="12" Foreground="Gray" TextTrimming="CharacterEllipsis" MaxLines="1" />
                </StackPanel>
                <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0">
                    <TextBlock Text="{Binding DisplayTime}" FontSize="12" Foreground="Gray" HorizontalAlignment="Right"/>
                    <Border Background="#FFFF4444" MinWidth="22" Height="20" CornerRadius="10" HorizontalAlignment="Right" Margin="0,4,0,0" Visibility="{Binding UnreadCount, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock Text="{Binding UnreadCountDisplay}" FontSize="11" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="6,0"/>
                    </Border>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <Style x:Key="ChatListItemStyle" TargetType="ListViewItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="AllowDrop" Value="False" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <ListViewItemPresenter ContentTransitions="{TemplateBinding ContentTransitions}" Content="{TemplateBinding Content}" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Center" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="ContextFlyout">
                <Setter.Value>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="刪除" Command="{Binding DataContext.DeleteChatCommand, ElementName=ChatListViewControl}" CommandParameter="{Binding}" />
                        <MenuFlyoutItem Text="置頂/取消置頂" Command="{Binding DataContext.PinChatCommand, ElementName=ChatListViewControl}" CommandParameter="{Binding}" />
                        <MenuFlyoutItem Text="靜音/取消靜音" Command="{Binding DataContext.MuteChatCommand, ElementName=ChatListViewControl}" CommandParameter="{Binding}" />
                    </MenuFlyout>
                </Setter.Value>
            </Setter>
        </Style>
    </views:MvxWindowsPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="聊天" FontSize="28" FontWeight="Light" Margin="24,16,24,4" />

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="16,0,16,8">
            <TextBox x:Name="SearchBox" Width="240" PlaceholderText="搜尋..." Text="{Binding SearchText, Mode=TwoWay}" TextChanged="SearchBox_TextChanged" />
            <ToggleButton x:Name="UnreadFilterButton" Content="未讀" Margin="12,0,0,0" IsChecked="{Binding ShowOnlyUnread, Mode=TwoWay}" Command="{Binding ToggleUnreadFilterCommand}" />
            <ToggleButton x:Name="PinnedFilterButton" Content="置頂" Margin="8,0,0,0" IsChecked="{Binding ShowOnlyPinned, Mode=TwoWay}" Command="{Binding TogglePinnedFilterCommand}" />
        </StackPanel>

        <ListView Grid.Row="2" x:Name="ChatListViewControl" ItemsSource="{Binding FilteredChatList}" ItemTemplate="{StaticResource ChatItemTemplate}" ItemContainerStyle="{StaticResource ChatListItemStyle}" SelectionMode="Single" SelectionChanged="ChatListView_SelectionChanged">
            <ListView.ItemContainerTransitions>
                <TransitionCollection>
                    <AddDeleteThemeTransition />
                    <ReorderThemeTransition />
                    <ContentThemeTransition />
                </TransitionCollection>
            </ListView.ItemContainerTransitions>
        </ListView>

        <Grid Grid.Row="2" Background="{ThemeResource ApplicationPageBackgroundThemeBrush}" Opacity="0.9" Visibility="{Binding IsRefreshing, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressRing Width="40" Height="40" IsActive="True" />
                <TextBlock Text="載入中..." FontSize="14" Foreground="Gray" Margin="0,8,0,0" />
            </StackPanel>
        </Grid>

        <Grid Grid.Row="2" Background="Transparent" Visibility="{Binding FilteredChatList.Count, Converter={StaticResource EmptyListToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="💬" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,12" />
                <TextBlock Text="暫無聊天" FontSize="18" Foreground="Gray" HorizontalAlignment="Center" />
                <TextBlock Text="開始與好友或群組對話..." FontSize="14" Foreground="Gray" HorizontalAlignment="Center" Margin="0,6,0,0" />
            </StackPanel>
        </Grid>
    </Grid>
</views:MvxWindowsPage>